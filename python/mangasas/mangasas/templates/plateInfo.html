{% extends "layout.html" %}
{% set active_page = active_page|default("plate") %}
{% from 'generalMacros.html' import dropdownload, rsyncmodal, hline %}

{% block head %}
	<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/index.css')}}">
{% endblock head %}

{% block code %}
{{js|safe}}
<script type='text/javascript'>

    // Load ifu div element when image on page is clicked
	$(function(){
		$('.ifuims').on('click',function(){
			$('.galinfo').hide();
			$($(this).attr('href')).fadeIn();
		});
	});
	
	// Load ifu div element if hash present when page loads
	$(function(){
		var hash = window.location.hash;
		$(String(hash)).fadeIn();
	});
	
	// Plate design layout toggle	
	$(function(){
		$('#pdtoggle').on('click',function(){
			if ($(this).hasClass('active')){
				$('#platedesign').hide();
				$('#platedesign').empty()
			} else {
				$('#platedesign').show();
				$('#platedesign').html('<h3><small>Unfinished</small></h3>')
				loadPlateDesign();
			}
		});
	});

	// Toggle between comment form categories
	$(function() {		
		$('#commentcat').change(function () {
    		$('.catissues').hide();
    		$('#catissue_'+$(this).val()).fadeIn();
    		$('.catcomments').hide();
    		$('#catcomment_'+$(this).val()).fadeIn();
		});
	});

	// Reset comment form
	function resetCommentForm() {
		$('#commentform').modal('hide');
		$('#addcomment_form').trigger("reset");
		$('#feedbackmessage').empty();
		$('textarea').val('');
	}
	
	// Submit add comment form
	function submitcomment() {

		// grab cube info
		var plateid = {{plate.id}};		
		var version = {{version|tojson|safe}};
		var cubepk = $('#cubepk').val();
		var ifuname = $('#ifuname').val(); 
				
		// grab comments from all boxes
		var comments = [];
		$('.commentfield').each(function(index){
			comments.push(this.value);
		});
		comments = JSON.stringify(comments);

		// grab all checked issues
		var issueids = [];
		$('input:checkbox.issues').each(function () {
       		var thisval = (this.checked ? $(this).val() : "");
       		if (thisval) {
       			issueids.push(parseInt(thisval.split('issue')[1]));
       		}
  		});
  		issueids = JSON.stringify(issueids);

		$.post($SCRIPT_ROOT + '/manga/addcomment', {'cubepk':cubepk,'plateid':plateid,'comments':comments, 'issueids':issueids, 'version':version, 'ifuname':ifuname},'json')
			.done(function(data){
				if (data.result['status'] < 0) {
					// bad submit
					resetCommentForm();
				} else {
					// good submit
                    if (data.result['message']!=''){
                    	var stat = (data.result['status'] == 0) ? 'danger' : 'success'; 
                        htmlstr = "<div class='alert alert-"+stat+"' role='alert'><h4>" + data.result['message'] + "</h4></div>";
                        $('#feedbackmessage').html(htmlstr);
                    }
                    if (data.result['status']==1){
                        setTimeout(resetCommentForm, 1500);
                    }
				}
			})
			.fail(function(data){
			});	

	}
	
	// Get previous comments on cube from specific user
	function getComment(cubepk, ifuname) {
	
		// grab and set cube info
		var plateid = {{plate.id}};
		var version = {{version|tojson|safe}};
		$('#cubepk').val(cubepk);
		$('#ifuname').val(ifuname);
											
		$.post($SCRIPT_ROOT + '/manga/getcomment', {'cubepk':cubepk,'plateid':plateid,'ifuname':ifuname,'version':version},'json') 
			.done(function(data){
				if (data.result['userid'] == 'sdss') {
					$('#loginform').modal('show');
				} else {
					$('#commentform').modal('show');
					populateComments(data);
				}
			})
			.fail(function(data){
			});							
	}
	
	// Populate comment fields with prior comments
	function populateComments(data) {
		$('.catcomments').each(function(index){

			var userlabel = $('#userlabel_'+(index+1)).text();
			var comments = data.result['comments'][index+1];
			var htmlstr="<option value='comment0' value='' selected></option>";

			for (var i=0; i<comments.length; ++i){
				htmlstr += '<option value="comment'+(i+1)+'">'+comments[i]+'</option>';
			}
							
			if (userlabel.search(data.result['membername']) < 0){
				userlabel += data.result['membername'];
			}
			$('#userlabel_'+(index+1)).text(userlabel);
			$('#prevusercomments_'+(index+1)).html(htmlstr);
			
		});	
	}		
	
	// Input selected comment option into new comment 
	$(function(){
		$('.usercomments').change(function() {
			var index = $(this).attr('id').search('_');
			var id = $(this).attr('id').slice(index+1);
			
			var selectedcomment = $('#prevusercomments_'+id+' option:selected').text();
			$('#commentfield_'+id).text(selectedcomment);
		});
	});
	
	// Login to trac
	function login() {
	
		var form = $('#login_form').serialize();
		
		$.post($SCRIPT_ROOT + '/manga/login', form,'json') 
			.done(function(data){
				resetLogin();
			})
			.fail(function(data){
			});				

	}
	
	// Reset Login
	function resetLogin() {
		$('#loginform').modal('hide');
		$('#login_form').trigger('reset');	
	}
	
		
</script>
{% endblock code %}




{% block body %}

{% if plate and good %}
	<div class='well' style='background-color:rgba(245,245,245,0.4)'>
		<div class='well'>
			{# Some General Plate Info #}
			<div class='row'>
				<div class='col-md-3'>
					<h1>Plate: {{plate.id}} <small>Version: {{version}} </small></h1>
				</div>
				{# Rsync button and modal #}
				<div class='col-md-1'>
				  	{{dropdownload('platedl', 'rsynclink')}}				
				</div>
            	{{rsyncmodal()}}

				<div class='col-md-1'>
					<button type='button' class='btn btn-primary' id='pdtoggle' data-toggle='button' aria-pressed='false'>Toggle Design Layout</button>
				</div>
			</div>
			<div class='row'>
				<div class='col-md-4'>
					<h1><small>add some general plate info here</small></h1>
					<table class='table table-condense'>
						<tbody>
							<tr><th>Label</th><td>{{plate.type}} Plate</td></tr>
							<tr><th>Plate Type</th><td>{{plate.platetype}}</td></tr>
							<tr><th>Survey Mode</th><td>{{plate.surveymode}}</td></tr>
							<tr><th>Date Observed</th><td>{{plate.dateobs}}</td></tr>
							<tr><th>RA,Dec</th><td>{{plate.ra}}, {{plate.dec}}</td></tr>
							<tr><th>SAS URL</th><td><a target='_blank' href='{{sasurl}}'>Data Link</a></td></tr>							
						</tbody>
					</table>
				</div>
				<div class='col-md-4 col-md-offset-1'>
					<div id='platedesign'>
					</div>
				</div>				
			</div>
		</div>
		{# Row of all Galaxy Images for Plate #}
		<div class='well'>
			<div class='row'>
				<div class='col-md-12'>
					<h2>Galaxy Images <small>Click for more info</small></h2>
				</div>
				{% if images %}
					{% for image in images %}
						<div class="col-xs-6 col-md-1">
							<div class='caption'>
								<h4>{{((image|split('/'))[-1]|split('.'))[0]}}</h4>
							</div>					
							<a href="#{{((image|split('/'))[-1]|split('.'))[0]}}" class="thumbnail ifuims">
								<img class='img-responsive' src="{{image}}" alt="..." >
							</a>
						</div>
					{% endfor %}
				{% else %}
					<div class='col-md-12'><h1> No IFU images found! </h1></div>
				{% endif %}
  			</div>
		</div>

		{# Drop-down DIV for each IFU #}
		{% for cube in cubes %}
		<div class='well galinfo' id='{{cube.ifu.name}}' style='display:none;'>
			<div class='row'>
				{# Left-hand side column of info #}
				<div class='col-md-4'>
					<h3>MaNGA Id: {{cube.mangaid}}</h3>
					<img class='img-responsive' src="{{ifudict[cube.ifu.name]['image']}}" alt="..." >
					
					<h4><small>More info here</small></h4>
					<div id='galdetail'>
						<h4>MJD Reduced: {{cube.header['MJDRED']}}</h4>
						<h4>RA, Dec: {{cube.header['OBJRA']}}, {{cube.header['OBJDEC']}}</h4>
					</div>
					
					<div class='btn-group-vertical'>
					<button type='button' class='btn btn-warning' onclick='getComment({{cube.pk}}, {{cube.ifu.name}})'>Add Comment</button>
					<a href='#commenttable' class='btn btn-success' id='showcomment'>Show Comments</a>
					<a href='{{cube.location}}' class='btn btn-primary' id='cubedl' download='{{cube.name}}'>Download Cube</a>
					<a href='{{cube.location|replace('CUBE','RSS')}}' class='btn btn-primary' id='rssdl' download='{{cube.name|replace('CUBE','RSS')}}'>Download RSS</a>
					</div>
				</div>


				{# Table for Sample parameters #}
				<div class='col-md-8'>
					<table class='table table-condensed' id='sampletable'>
						<thead>
							<tr>
								<th>Parameter</th><th>Value</th>
							</tr>
						</thead>
						<tbody>
							{% for key,val in ifudict[cube.ifu.name].iteritems() %}
								<tr>
									<th>{{key}}</th>
									{% if key != 'image' %} <td>{{val}}</td> {% else %} <td><a target='_blank' href='{{val}}'>{{val}}</a></td> {% endif %}
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>	
			</div> {# end row #}
			
			{{hline()}}
			
			{# Comment Table #}
			<div class='comments' id='commenttable'>
				<div class='row'>
					<div class='col-md-8'>
						<h4>Comments for Cube {{cube.ifu.name}}</h4>
					</div>
					<div class='col-md-4'>
						<a href='#{{cube.ifu.name}}' class='btn btn-default btn-sm'><span class='glyphicon glyphicon-chevron-up'></span></a>
					</div>
				</div>
				{# Comment Table Results #}
				<div class='row'>
					<div class='col-md-12'>
						{% if comments %}
						<div class='table-responsive' id='commenttable'>
							{#{{table(cols, keys, comments[cube.ifu.name], flags, stage='3d')}}#}
						</div>
						{% else %}
							<h4> No comments found. </h4>
						{% endif %}
					</div>
				</div>				
			</div>

		</div>
		{% endfor %}

		{# Comment Form #}
		<div class='comments'>
		<form class='form' role='form' method='post' action='addComment' id='addcomment_form'>
			<div class='modal fade commentmodal' id='commentform' tabindex='-1' role='dialog' aria-labeledby='commentlabel' aria-hidden='true'>
				<div class='modal-dialog modal-lg'>
					<div class='modal-content'>
						{# Comment header #}
						<div class='modal-header well'>	
							<button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="resetCommentForm()"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">Comment Form</h4>								
						</div>
						{# Comment body #}
						<div class='modal-body well'>
							<div class='well container-fluid' style='background-color:rgba(245,245,245,0.4)'>
								<div class='row'>
									<input class='hidden' id='cubepk' name='cubepk' value=''/>
									<input class='hidden' id='ifuname' name='ifuname' value=''/>
									{# Comment Categories #}
									<div class='col-md-4'>
										<label for='commentcat' class='control-label'>Category / Issues:</label>
										<select class='form-control' id='commentcat'>
											{% for catid, category in feedback.category.items() %}
												{% if loop.index0 == 0 %}
													<option id='{{catid}}' value='{{category.key}}' selected>{{category.category}}</option>
												{% else %}
													<option id='{{catid}}' value='{{category.key}}'>{{category.category}}</option>
												{% endif %}
											{% endfor %}
										</select>     
									</div>
									{# Comment Issues #}
									<div class='col-md-8'>
										{% for catid, category in feedback.category.items() %}
											<div class='catissues' id='catissue_{{category.key}}' style='display:{{"none" if loop.index0 != 0}};'>
												{% for issid,issue in category.issues.items() %}
													{% if loop.index0 % 3 == 0 %}<div class='row'>{% endif %}
													<div class='col-md-4'>
													<div class='checkbox'>
														<label class='checkbox-inline'><input class='issues' id='issue{{issid}}' type='checkbox' value='issue{{issid}}'>{{issue}}</label>
													</div>
													</div>
													{% if loop.index0 % 3 == 2 or loop.last %}</div>{% endif %}
												{% endfor %}
											</div>
										{% endfor %}
									</div>																					
								</div>
								{# Comment Comments #}
								{% for catid, category in feedback.category.items() %}
								<div class='catcomments' id='catcomment_{{category.key}}' style='display:{{"none" if loop.index0 != 0}};'>
									{# Previous comments from user #}
									<div class='row'>
										<div class='col-md-10'>
											<label id='userlabel_{{catid}}'>Previous Comments from User: </label>
											<select class='usercomments form-control' id='prevusercomments_{{catid}}'>
											</select>
										</div>
									</div>
									{# Comment text box #}
									<div class='row'>
										<div class='col-md-10'>
											<label for='commentfield' class='control-label'>Comment:</label>
											<textarea class='form-control commentfield' rows='5' id='commentfield_{{catid}}' name='commentfield' placeholder='Comment for {{category.category}}'></textarea>
										</div>
									</div>
								</div>
								{% endfor %}
							</div>	
						</div> {# end modal body #}
						{# Comment Footer #}
						<div class='modal-footer well'>
							{# Feedback message and Comment submit button #}	
							<div class='row'>
								<div class='col-md-9' id='feedbackmessage'>
								</div>
								<div class='col-md-3'>
									<button type="button" onclick='submitcomment()' name="submitcomment_form" id='subcomment' class="btn btn-primary btn-lg" >Submit</button>
								</div>
							</div>								
						</div>
					</div>
				</div>
			</div>{# end comment modal #}
		</form>
		</div>

		{# Login Modal #}
		<div class='login'>
		<form class='form' role='form' method='post' action='login' id='login_form'>
			<div class='modal fade loginmodal' id='loginform' tabindex='-1' role='dialog' aria-labeledby='loginlabel' aria-hidden='true'>
				<div class='modal-dialog'>
					<div class='modal-content'>	
						{# Header #}
						<div class='modal-header well'>	
							<button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="resetLogin()"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">Trac User Login </h4>								
						</div>
						{# Body #}
						<div class='modal-body well'>
							<div class='row'>
								<div class='col-md-10'>
									{# Username #}
									<div class='form-group'>
										<label for='username'>Username: </label>
										<input type='text' class='form-control input-sm' name='username' placeholder='Username' value="" id='username'/>
									</div>
									{# Password #}
									<div class='form-group'>
										<label for='password'>Password: </label>
										<input type='password' class='form-control input-sm' name='password' placeholder='Password' value="" id='password'/>
									</div>	
								</div>
							</div>
						</div>
						{# Footer #}
						<div class='modal-footer well'>
							{# Login message and Comment submit button #}	
							<div class='row'>
								<div class='col-md-9' id='loginmessage'>
								</div>
								<div class='col-md-3'>
									<button type="button" onclick='login()' name="submitlogin_form" id='sublogin' class="btn btn-primary btn-lg" >Submit</button>
								</div>
							</div>								
						</div>						
					</div>
				</div>
			</div> {# end login modal #}
		</form>
		</div>

	</div>
{% elif not plate %}
	<div class='well'>
		<h1>No plate selected</h1>	
	</div>
{% elif plate and not good %}
	<div class='well'>
		<h1> Plate {{plate.id}} <small>(version: {{version}})</small> is not a valid plate! <h1>
	</div>
{% endif %}


{% endblock body %}